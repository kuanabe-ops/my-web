import React, { useState, useEffect } from 'react';
import { 
  Plus, 
  Trash2, 
  Check, 
  X, 
  Settings, 
  ChevronRight, 
  Briefcase, 
  Map, 
  ArrowLeft,
  Save,
  AlertCircle
} from 'lucide-react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

// --- 全域顏色設定 ---
const COLORS = ['#171717', '#404040', '#737373', '#a3a3a3', '#d4d4d4', '#e5e5e5'];

// --- 通用按鈕組件 ---
const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
  const variants = {
    primary: "bg-neutral-900 text-white hover:bg-neutral-800 shadow-sm",
    secondary: "bg-neutral-100 text-neutral-600 hover:bg-neutral-200",
    danger: "bg-red-50 text-red-500 hover:bg-red-100",
    ghost: "bg-transparent text-neutral-500 hover:bg-neutral-50",
    outline: "border border-neutral-200 text-neutral-600 hover:bg-neutral-50"
  };

  return (
    <button 
      onClick={onClick} 
      className={`px-4 py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 text-sm tracking-wide active:scale-95 disabled:opacity-30 ${variants[variant]} ${className}`}
      {...props}
    >
      {children}
    </button>
  );
};

export default function App() {
  // --- 狀態初始化 ---
  const [gear, setGear] = useState(() => JSON.parse(localStorage.getItem('ultra_gear') || '[]'));
  const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('ultra_cats') || '[{"id":"c1","name":"睡眠系統"},{"id":"c2","name":"背負系統"},{"id":"c3","name":"炊具飲食"}]'));
  const [trips, setTrips] = useState(() => JSON.parse(localStorage.getItem('ultra_trips') || '[]'));

  // UI 狀態
  const [activeTab, setActiveTab] = useState('gear'); // 'gear' | 'trips'
  const [view, setView] = useState('list'); // 'list' | 'gear-form' | 'trip-form' | 'cat-manager'
  
  // 編輯暫存
  const [editingId, setEditingId] = useState(null);
  const [formData, setFormData] = useState({});
  const [newCatName, setNewCatName] = useState("");
  
  // Modal 管理 (穩定版)
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null); 
  const [showCatConflict, setShowCatConflict] = useState(null); 

  // 資料同步
  useEffect(() => localStorage.setItem('ultra_gear', JSON.stringify(gear)), [gear]);
  useEffect(() => localStorage.setItem('ultra_cats', JSON.stringify(categories)), [categories]);
  useEffect(() => localStorage.setItem('ultra_trips', JSON.stringify(trips)), [trips]);

  // --- 穩定觸發器 ---
  const openDeleteConfirm = (type, id) => {
    setTimeout(() => {
      setShowDeleteConfirm({ type, id });
    }, 0);
  };

  // --- 資料處理器 ---
  const handleGearSubmit = () => {
    if (!formData.name) return;
    const item = {
      ...formData,
      id: editingId || Date.now().toString(),
      weight: parseFloat(formData.weight) || 0,
      category: formData.category || ''
    };
    setGear(prev => editingId ? prev.map(g => g.id === editingId ? item : g) : [...prev, item]);
    setView('list');
    setFormData({});
    setEditingId(null);
  };

  const handleTripSubmit = () => {
    if (!formData.name) return;
    const trip = {
      ...formData,
      id: editingId || Date.now().toString(),
      createdAt: formData.createdAt || Date.now(),
      selectedGear: formData.selectedGear || {}
    };
    setTrips(prev => editingId ? prev.map(t => t.id === editingId ? trip : t) : [trip, ...prev]);
    setView('list');
    setFormData({});
    setEditingId(null);
  };

  const handleDelete = () => {
    if (!showDeleteConfirm) return;
    const { type, id } = showDeleteConfirm;
    if (type === 'gear') setGear(prev => prev.filter(g => g.id !== id));
    if (type === 'trip') setTrips(prev => prev.filter(t => t.id !== id));
    setShowDeleteConfirm(null);
    setFormData({});
    setEditingId(null);
    setView('list');
  };

  const addCategory = () => {
    if (!newCatName.trim()) return;
    setCategories(prev => [...prev, { id: Date.now().toString(), name: newCatName.trim() }]);
    setNewCatName("");
  };

  const deleteCategory = (id) => {
    const hasItems = gear.some(g => g.category === id);
    if (hasItems) {
      const cat = categories.find(c => c.id === id);
      setShowCatConflict({ id, name: cat.name });
    } else {
      setCategories(prev => prev.filter(c => c.id !== id));
    }
  };

  const getTripStats = (tripData) => {
    const selected = tripData.selectedGear || {};
    let total = 0;
    const cats = {};
    gear.forEach(g => {
      if (selected[g.id] === 'take') {
        total += g.weight;
        const cName = categories.find(c => c.id === g.category)?.name || '未分類';
        cats[cName] = (cats[cName] || 0) + g.weight;
      }
    });
    const pieData = Object.entries(cats).map(([name, value]) => ({
      name,
      value,
      percent: total > 0 ? ((value / total) * 100).toFixed(1) : 0
    })).sort((a, b) => b.value - a.value);
    return { total, pieData };
  };

  // --- 主渲染邏輯 ---
  return (
    <div className="max-w-md mx-auto min-h-screen bg-white text-neutral-800 font-sans relative">
      
      {/* 1. 裝備編輯 View (改回 Inline 確保焦點不丟失) */}
      {view === 'gear-form' && (
        <div className="p-6 pt-12 animate-in slide-in-from-right-4 duration-300">
          <button onClick={() => setView('list')} className="mb-8 flex items-center text-neutral-400 text-sm">
            <ArrowLeft size={18} className="mr-1" /> 返回清單
          </button>
          <div className="space-y-6">
            <div className="space-y-1">
              <label className="text-[10px] uppercase tracking-widest text-neutral-400 ml-1">裝備名稱</label>
              <input 
                className="w-full bg-neutral-50 p-4 rounded-xl outline-none focus:ring-1 focus:ring-neutral-200 font-light"
                value={formData.name || ''}
                onChange={e => setFormData({...formData, name: e.target.value})}
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1">
                <label className="text-[10px] uppercase tracking-widest text-neutral-400 ml-1">重量 (g)</label>
                <input 
                  type="number"
                  className="w-full bg-neutral-50 p-4 rounded-xl outline-none font-light"
                  value={formData.weight || ''}
                  onChange={e => setFormData({...formData, weight: e.target.value})}
                />
              </div>
              <div className="space-y-1">
                <label className="text-[10px] uppercase tracking-widest text-neutral-400 ml-1">分類</label>
                <select 
                  className="w-full bg-neutral-50 p-4 rounded-xl outline-none font-light appearance-none"
                  value={formData.category || ''}
                  onChange={e => setFormData({...formData, category: e.target.value})}
                >
                  <option value="">未分類</option>
                  {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
            </div>
            <div className="space-y-1">
              <label className="text-[10px] uppercase tracking-widest text-neutral-400 ml-1">描述 (選填)</label>
              <input 
                className="w-full bg-neutral-50 p-4 rounded-xl outline-none font-light"
                value={formData.desc || ''}
                onChange={e => setFormData({...formData, desc: e.target.value})}
              />
            </div>
            <div className="pt-8 space-y-3">
              <Button onClick={handleGearSubmit} className="w-full py-4"><Save size={18}/> 儲存裝備</Button>
              {editingId && (
                <Button onClick={() => openDeleteConfirm('gear', editingId)} variant="danger" className="w-full py-4 bg-transparent border-0 text-red-400">
                  <Trash2 size={18}/> 刪除裝備
                </Button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* 2. 分類管理 View */}
      {view === 'cat-manager' && (
        <div className="p-6 pt-12 animate-in slide-in-from-right-4 duration-300">
          <button onClick={() => setView('list')} className="mb-8 flex items-center text-neutral-400 text-sm">
            <ArrowLeft size={18} className="mr-1" /> 返回清單
          </button>
          <div className="space-y-4 mb-10">
            {categories.map(cat => (
              <div key={cat.id} className="flex gap-2">
                <input 
                  className="flex-1 bg-neutral-50 px-4 py-3 rounded-xl outline-none text-sm"
                  value={cat.name}
                  onChange={e => setCategories(prev => prev.map(c => c.id === cat.id ? {...c, name: e.target.value} : c))}
                />
                <button onClick={() => deleteCategory(cat.id)} className="p-3 text-neutral-300 hover:text-red-400"><Trash2 size={18}/></button>
              </div>
            ))}
          </div>
          <div className="border-t pt-6 space-y-4">
            <label className="text-[10px] uppercase tracking-widest text-neutral-400 ml-1">新增分類</label>
            <div className="flex gap-2">
              <input 
                className="flex-1 bg-neutral-50 px-4 py-3 rounded-xl outline-none"
                placeholder="分類名稱..."
                value={newCatName}
                onChange={e => setNewCatName(e.target.value)}
              />
              <Button onClick={addCategory} disabled={!newCatName}><Plus size={20}/></Button>
            </div>
          </div>
        </div>
      )}

      {/* 3. 行程規劃 View */}
      {view === 'trip-form' && (() => {
        const { total, pieData } = getTripStats(formData);
        return (
          <div className="flex flex-col h-screen bg-white">
            <div className="p-4 border-b flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur z-10">
              <button onClick={() => setView('list')} className="text-neutral-400 p-2"><X size={20}/></button>
              <div className="text-sm font-medium">{(total/1000).toFixed(2)} kg</div>
              <Button onClick={handleTripSubmit} className="h-9 px-6 py-0 rounded-full text-xs">完成</Button>
            </div>
            <div className="flex-1 overflow-y-auto p-6 pb-24">
              <input 
                className="text-2xl font-light w-full outline-none mb-2"
                placeholder="旅程名稱..."
                value={formData.name || ''}
                onChange={e => setFormData({...formData, name: e.target.value})}
              />
              <div className="flex items-center gap-2 mb-8">
                <input 
                  type="number"
                  className="w-12 border-b text-center outline-none"
                  value={formData.days || ''}
                  onChange={e => setFormData({...formData, days: e.target.value})}
                />
                <span className="text-neutral-400 text-sm">天數</span>
              </div>

              {total > 0 && (
                <div className="mb-10">
                  <div className="h-40 w-full mb-6">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie data={pieData} cx="50%" cy="50%" innerRadius={40} outerRadius={60} paddingAngle={4} dataKey="value" stroke="none">
                          {pieData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                        </Pie>
                        <Tooltip />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                  <div className="space-y-2">
                    {pieData.map((d, i) => (
                      <div key={i} className="flex justify-between text-xs items-center">
                        <div className="flex items-center gap-2">
                          <div className="w-1.5 h-1.5 rounded-full" style={{backgroundColor: COLORS[i % COLORS.length]}} />
                          <span className="text-neutral-500">{d.name}</span>
                        </div>
                        <div className="flex gap-4">
                          <span className="text-neutral-300">{d.percent}%</span>
                          <span className="text-neutral-800 w-12 text-right">{d.value}g</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {editingId && (
                <Button onClick={() => openDeleteConfirm('trip', editingId)} variant="danger" className="w-full mb-8 text-xs bg-red-50/50">刪除此行程</Button>
              )}

              <div className="space-y-8">
                {categories.concat({id:'', name:'未分類'}).map(cat => {
                  const items = gear.filter(g => (g.category || '') === (cat.id || ''));
                  if (items.length === 0) return null;
                  return (
                    <div key={cat.id || 'uncat'}>
                      <div className="text-[10px] uppercase tracking-widest text-neutral-300 mb-4 border-b pb-1">{cat.name}</div>
                      {items.map(item => {
                        const status = (formData.selectedGear || {})[item.id];
                        return (
                          <div key={item.id} className="flex items-center justify-between py-3">
                            <div className={`flex-1 transition-opacity ${status === 'leave' ? 'opacity-20 line-through' : status === 'take' ? 'opacity-100' : 'opacity-50'}`}>
                              <div className="text-sm">{item.name}</div>
                              <div className="text-[10px] text-neutral-400">{item.weight}g</div>
                            </div>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => {
                                  const next = status === 'leave' ? undefined : 'leave';
                                  setFormData({...formData, selectedGear: {...(formData.selectedGear || {}), [item.id]: next}})
                                }}
                                className={`w-9 h-9 rounded-full flex items-center justify-center transition-colors ${status === 'leave' ? 'bg-neutral-200 text-neutral-600' : 'bg-neutral-50 text-neutral-300'}`}
                              ><X size={16}/></button>
                              <button 
                                onClick={() => {
                                  const next = status === 'take' ? undefined : 'take';
                                  setFormData({...formData, selectedGear: {...(formData.selectedGear || {}), [item.id]: next}})
                                }}
                                className={`w-9 h-9 rounded-full flex items-center justify-center transition-colors shadow-sm ${status === 'take' ? 'bg-neutral-900 text-white' : 'bg-neutral-50 text-neutral-300'}`}
                              ><Check size={16}/></button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      })()}

      {/* 4. 清單主介面 */}
      {view === 'list' && (
        <div className="animate-in fade-in duration-500">
          {activeTab === 'gear' ? (
            <div className="p-6 pb-24">
              <div className="flex justify-end mb-6">
                <button onClick={() => setView('cat-manager')} className="text-neutral-300 hover:text-neutral-900 transition-colors"><Settings size={20}/></button>
              </div>
              {gear.length === 0 ? (
                <div className="h-96 flex flex-col items-center justify-center text-neutral-200 font-light">
                  <Briefcase size={40} strokeWidth={1} className="mb-2"/> 尚無裝備
                </div>
              ) : (
                <div className="space-y-10">
                  {categories.concat({id:'', name:'未分類'}).map(cat => {
                    const items = gear.filter(g => (g.category || '') === (cat.id || ''));
                    if (items.length === 0) return null;
                    return (
                      <div key={cat.id || 'uncat'}>
                        <h3 className="text-[10px] uppercase tracking-[0.2em] text-neutral-400 border-b border-neutral-100 pb-2 mb-4">{cat.name}</h3>
                        {items.map(item => (
                          <div 
                            key={item.id} 
                            onClick={() => { setEditingId(item.id); setFormData(item); setView('gear-form'); }}
                            className="flex justify-between items-center py-4 border-b border-neutral-50 active:bg-neutral-50 px-1 -mx-1"
                          >
                            <div>
                              <div className="text-sm font-medium">{item.name}</div>
                              {item.desc && <div className="text-[10px] text-neutral-400 font-light">{item.desc}</div>}
                            </div>
                            <div className="text-xs text-neutral-400">{item.weight}g</div>
                          </div>
                        ))}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          ) : (
            <div className="p-6 pb-24 space-y-4 pt-12">
              {trips.length === 0 ? (
                <div className="h-96 flex flex-col items-center justify-center text-neutral-200 font-light">
                  <Map size={40} strokeWidth={1} className="mb-2"/> 開始規劃旅程
                </div>
              ) : (
                trips.map(trip => {
                  const { total } = getTripStats(trip);
                  return (
                    <div 
                      key={trip.id} 
                      onClick={() => { setEditingId(trip.id); setFormData(trip); setView('trip-form'); }}
                      className="p-5 border border-neutral-100 rounded-2xl shadow-sm active:scale-95 transition-transform"
                    >
                      <div className="flex justify-between items-start mb-4">
                        <h3 className="font-medium">{trip.name}</h3>
                        <span className="text-[10px] text-neutral-300">{new Date(trip.createdAt).toLocaleDateString()}</span>
                      </div>
                      <div className="flex justify-between items-end">
                        <div className="flex gap-6">
                          <div className="text-xs text-neutral-400">天數 <span className="text-neutral-900 ml-1">{trip.days || 0}</span></div>
                          <div className="text-xs text-neutral-400">總重 <span className="text-neutral-900 ml-1">{(total/1000).toFixed(2)}kg</span></div>
                        </div>
                        <ChevronRight size={16} className="text-neutral-200" />
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          )}

          {/* 懸浮與導覽 */}
          <button 
            onClick={() => { setFormData({}); setEditingId(null); setView(activeTab === 'gear' ? 'gear-form' : 'trip-form'); }}
            className="fixed bottom-24 right-6 w-14 h-14 bg-neutral-900 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-transform z-20"
          >
            <Plus size={28} />
          </button>

          <nav className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-neutral-100 flex justify-around p-4 pb-8 z-20">
            <button onClick={() => setActiveTab('gear')} className={`flex flex-col items-center gap-1 w-1/2 ${activeTab === 'gear' ? 'text-neutral-900' : 'text-neutral-300'}`}>
              <Briefcase size={20} strokeWidth={activeTab === 'gear' ? 2 : 1.5} />
              <span className="text-[9px] uppercase tracking-widest font-bold">裝備清單</span>
            </button>
            <button onClick={() => setActiveTab('trips')} className={`flex flex-col items-center gap-1 w-1/2 ${activeTab === 'trips' ? 'text-neutral-900' : 'text-neutral-300'}`}>
              <Map size={20} strokeWidth={activeTab === 'trips' ? 2 : 1.5} />
              <span className="text-[9px] uppercase tracking-widest font-bold">旅程規劃</span>
            </button>
          </nav>
        </div>
      )}

      {/* --- Modals --- */}
      {(showDeleteConfirm !== null) && (
        <div className="fixed inset-0 bg-neutral-900/40 backdrop-blur-sm z-[100] flex items-end p-6">
          <div className="bg-white w-full p-6 rounded-3xl animate-in slide-in-from-bottom-10">
            <h3 className="text-lg font-medium mb-2">確定刪除？</h3>
            <p className="text-sm text-neutral-400 font-light mb-8">此動作無法復原，裝備或行程將永久移除。</p>
            <div className="grid grid-cols-2 gap-3">
              <Button variant="secondary" onClick={() => setShowDeleteConfirm(null)}>取消</Button>
              <Button variant="danger" onClick={handleDelete}>確定刪除</Button>
            </div>
          </div>
        </div>
      )}

      {(showCatConflict !== null) && (
        <div className="fixed inset-0 bg-neutral-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-sm p-6 rounded-3xl animate-in fade-in zoom-in duration-200">
            <div className="flex items-center gap-2 text-neutral-400 mb-2">
              <AlertCircle size={20} />
              <h3 className="font-medium text-neutral-800">分類仍有裝備</h3>
            </div>
            <p className="text-sm text-neutral-500 font-light mb-6 leading-relaxed">「{showCatConflict.name}」內尚有裝備，請選擇處理方式：</p>
            <div className="space-y-2">
              <Button 
                className="w-full text-xs" 
                onClick={() => { 
                  setActiveTab('gear');
                  setView('list');
                  setShowCatConflict(null); 
                }}
              >
                前往該分類編輯
              </Button>
              <Button variant="danger" className="w-full text-xs bg-white border border-red-100" onClick={() => {
                setGear(prev => prev.map(g => g.category === showCatConflict.id ? {...g, category: ''} : g));
                setCategories(prev => prev.filter(c => c.id !== showCatConflict.id));
                setShowCatConflict(null);
              }}>
                直接刪除 (裝備變為未分類)
              </Button>
              <Button variant="ghost" className="w-full" onClick={() => setShowCatConflict(null)}>取消</Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

